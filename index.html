<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solara</title>

<!-- 本地 CSS -->
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/desktop.css" id="desktopStylesheet" media="(min-width: 821px)">
<link rel="stylesheet" href="css/mobile.css" id="mobileStylesheet" media="(max-width: 820px)">

<!-- Font Awesome -->
<link rel="stylesheet" href="css/font-awesome.min.css">

<!-- Firebase SDK (CDN 保留) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<!-- Header -->
<div class="header">
    <h1>Solara</h1>
    <div class="theme-switch-wrapper">
        <button id="themeToggleButton" class="theme-toggle-button" type="button" aria-label="Toggle theme">
            <i class="fas fa-sun theme-icon theme-icon--sun"></i>
            <i class="fas fa-moon theme-icon theme-icon--moon"></i>
        </button>
    </div>
</div>

<!-- Authentication Panel -->
<div id="authPanel">
    <h2>Login / Register</h2>
    <input type="email" id="emailInput" placeholder="Email">
    <input type="password" id="passwordInput" placeholder="Password">
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Register</button>
    <div id="authMessage"></div>
</div>

<!-- Messages Panel -->
<div id="messagesPanel">
    <h2>Messages</h2>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Write a message..." />
    <button id="sendBtn">Send</button>
</div>

<!-- Music Player -->
<div class="main-content">
    <div class="cover-area">
        <div class="mobile-turntable" id="mobileTurntable">
            <div class="mobile-turntable__platter">
                <div class="album-cover" id="albumCover">
                    <div class="placeholder"><i class="fas fa-music"></i></div>
                </div>
            </div>
        </div>
        <div class="current-song-info">
            <div class="current-song-title" id="currentSongTitle">Select a song to play</div>
            <div class="current-song-artist" id="currentSongArtist">Unknown Artist</div>
        </div>
    </div>

    <div class="mobile-panel" id="mobilePanel">
        <div class="playlist active empty" id="playlist">
            <div class="playlist-header">
                <div class="playlist-label" aria-hidden="true">Playlist</div>
                <div class="playlist-actions-tray" role="group" aria-label="Playlist actions">
                    <input id="importPlaylistInput" type="file" accept="application/json" hidden />
                    <button id="importPlaylistBtn" type="button" title="Import playlist">
                        <i class="fas fa-file-import"></i>
                    </button>
                    <button id="exportPlaylistBtn" type="button" title="Export playlist">
                        <i class="fas fa-file-export"></i>
                    </button>
                    <button id="clearPlaylistBtn" type="button" onclick="clearPlaylist()" title="Clear playlist">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="playlist-scroll">
                <div class="playlist-items" id="playlistItems"></div>
            </div>
        </div>
    </div>
</div>

<!-- Audio Element -->
<audio id="audioPlayer" preload="metadata" playsinline></audio>

<!-- JS Scripts -->
<script src="js/jquery-3.6.0.min.js"></script>
<script src="js/index.js"></script>
<script src="js/mobile.js"></script>

<!-- Firebase & Messages Logic -->
<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAu-M38kbfzqlH6hXg4HD1pC2cIamt8XK0",
    authDomain: "solara-music.firebaseapp.com",
    databaseURL: "https://solara-music-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "solara-music",
    storageBucket: "solara-music.firebasestorage.app",
    messagingSenderId: "35854719518",
    appId: "1:35854719518:web:fe3cfc9e4587ce82de2c0f",
    measurementId: "G-NS6BMC6WRE"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');
  const registerBtn = document.getElementById('registerBtn');
  const authMessage = document.getElementById('authMessage');
  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  // Register
  registerBtn.addEventListener('click', () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      auth.createUserWithEmailAndPassword(email, password)
          .then(userCredential => {
              authMessage.innerText = 'Registered & Logged in as: ' + email;
              loadMessages();
          })
          .catch(error => authMessage.innerText = 'Error: ' + error.message);
  });

  // Login
  loginBtn.addEventListener('click', () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      auth.signInWithEmailAndPassword(email, password)
          .then(userCredential => {
              authMessage.innerText = 'Logged in as: ' + email;
              loadMessages();
          })
          .catch(error => authMessage.innerText = 'Error: ' + error.message);
  });

  // Send message
  sendBtn.addEventListener('click', () => {
      const content = messageInput.value.trim();
      if (!auth.currentUser) { alert('You must login first!'); return; }
      if (!content) return;
      db.collection('messages').add({
          username: auth.currentUser.email,
          content: content,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => { messageInput.value=''; loadMessages(); })
      .catch(err => alert(err.message));
  });

  // Load messages
  function loadMessages() {
      db.collection('messages').orderBy('createdAt','asc').get().then(snapshot=>{
          messagesDiv.innerHTML='';
          snapshot.forEach(doc=>{
              const data=doc.data();
              const div=document.createElement('div');
              div.innerHTML=`<strong>${data.username}</strong>: ${data.content}`;
              messagesDiv.appendChild(div);
          });
      });
  }

  // Auth state observer
  auth.onAuthStateChanged(user=>{
      if(user){
          authMessage.innerText='Logged in as: '+user.email;
          loadMessages();
      } else {
          authMessage.innerText='Not logged in';
      }
  });
</script>

</body>
</html>
