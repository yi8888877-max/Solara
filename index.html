<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Music</title>
<meta name="apple-mobile-web-app-title" content="Music">
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
<link rel="shortcut icon" href="/favicon.png">
<link rel="mask-icon" href="/favicon.svg" color="#5bbad5">
<link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="180x180" href="/favicon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="stylesheet" href="css/style.css">

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAu-M38kbfzqlH6hXg4HD1pC2cIamt8XK0",
  authDomain: "solara-music.firebaseapp.com",
  databaseURL: "https://solara-music-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "solara-music",
  storageBucket: "solara-music.firebasestorage.app",
  messagingSenderId: "35854719518",
  appId: "1:35854719518:web:fe3cfc9e4587ce82de2c0f",
  measurementId: "G-NS6BMC6WRE"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

function register(email, password) { return auth.createUserWithEmailAndPassword(email, password); }
function login(email, password) { return auth.signInWithEmailAndPassword(email, password); }
function logout() { return auth.signOut(); }

auth.onAuthStateChanged(user => {
  if(user) {
    document.querySelectorAll('.userEmail').forEach(el=>el.textContent=user.email);
    document.querySelectorAll('.loginSection').forEach(el=>el.style.display='none');
    document.querySelectorAll('.playerSection').forEach(el=>el.style.display='block');
    loadPlayHistory();
  } else {
    document.querySelectorAll('.loginSection').forEach(el=>el.style.display='block');
    document.querySelectorAll('.playerSection').forEach(el=>el.style.display='none');
  }
});

function savePlayRecord(songName, artist) {
  const user = auth.currentUser;
  if(!user) return;
  db.collection('users').doc(user.uid).collection('history').add({
    songName, artist,
    playedAt: firebase.firestore.FieldValue.serverTimestamp()
  });
}

function loadPlayHistory() {
  const user = auth.currentUser;
  if(!user) return;
  const historyContainers = document.querySelectorAll('.historyList');
  historyContainers.forEach(container=>container.innerHTML='');
  db.collection('users').doc(user.uid).collection('history').orderBy('playedAt','desc').get().then(snapshot=>{
    snapshot.docs.forEach(doc=>{
      const data = doc.data();
      const div = document.createElement('div');
      div.className='history-item';
      div.textContent=`${data.songName} - ${data.artist}`;
      historyContainers.forEach(container=>container.appendChild(div));
    });
  });
}
</script>

<script>
(function () {
    const ua = navigator.userAgent || "";
    const isMobileUA = /android|iphone|ipad|ipod|mobile|blackberry|phone|opera mini|windows phone/i.test(ua);
    const isSmallScreen = typeof window.matchMedia === "function" && window.matchMedia("(max-width: 820px)").matches;
    const isMobile = isMobileUA || isSmallScreen;
    window.__SOLARA_IS_MOBILE = isMobile;
    if (!isMobile) {
        document.documentElement.classList.add("desktop-view");
        const desktopLink = document.createElement("link");
        desktopLink.rel = "stylesheet";
        desktopLink.href = "css/desktop.css";
        desktopLink.id = "desktopStylesheet";
        document.head.appendChild(desktopLink);
        return;
    }
    document.documentElement.classList.add("mobile-view");
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = "css/mobile.css";
    link.id = "mobileStylesheet";
    document.head.appendChild(link);
    const setViewportUnit = () => {
        const viewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
        document.documentElement.style.setProperty("--mobile-vh", `${viewportHeight}px`);
    };
    const applyBodyClass = () => { if(document.body){document.body.classList.add("mobile-view"); setViewportUnit();} };
    if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",applyBodyClass,{once:true});}
    else{applyBodyClass();}
    window.addEventListener("resize",setViewportUnit);
    window.addEventListener("orientationchange",setViewportUnit);
    if(window.visualViewport){window.visualViewport.addEventListener("resize",setViewportUnit); window.visualViewport.addEventListener("scroll",setViewportUnit);}
    setViewportUnit();
})();
</script>
</head>
<body>
<div class="background-stage" id="backgroundStage">
  <div class="background-stage__layer background-stage__layer--base" id="backgroundBaseLayer"></div>
  <div class="background-stage__layer background-stage__layer--transition" id="backgroundTransitionLayer"></div>
</div>

<div class="container" id="mainContainer">

<!-- Login Section (common for desktop and mobile) -->
<div class="loginSection">
  <h2>Login / Register</h2>
  <input type="email" id="emailInput" placeholder="Email">
  <input type="password" id="passwordInput" placeholder="Password">
  <button onclick="login(emailInput.value,passwordInput.value).catch(e=>alert(e.message))">Login</button>
  <button onclick="register(emailInput.value,passwordInput.value).catch(e=>alert(e.message))">Register</button>
</div>

<!-- Player Section (common for desktop and mobile) -->
<div class="playerSection" style="display:none;">
  <button onclick="logout()">Logout</button>
  <h2>Now Playing</h2>
  <div id="currentSongTitle">Select a song</div>
  <div id="currentSongArtist">Unknown Artist</div>
  <button onclick="savePlayRecord(currentSongTitle.textContent,currentSongArtist.textContent)">Save Play</button>
  
  <h2>My Play History</h2>
  <div class="historyList"></div>
</div>

</div>

<audio id="audioPlayer" preload="metadata" playsinline></audio>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="js/index.js"></script>
<script>
if(window.__SOLARA_IS_MOBILE){
  const mobileScript=document.createElement('script');
  mobileScript.src='js/mobile.js';
  mobileScript.async=false;
  mobileScript.defer=false;
  document.body.appendChild(mobileScript);
}
</script>
</body>
</html>
